# üèóÔ∏è –ü–ª–∞–Ω –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Todo App: Clean Architecture + React 19 + Next.js 15

> **–¶–µ–ª—å:** –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞–≤—ã–∫–∏ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ö–ª—é—á–µ–≤—ã–µ –†–µ—à–µ–Ω–∏—è](#–∫–ª—é—á–µ–≤—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
2. [–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –û—Å–Ω–æ–≤—ã](#—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ-–æ—Å–Ω–æ–≤—ã)
3. [–ü–æ—à–∞–≥–æ–≤–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–ø–æ—à–∞–≥–æ–≤–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
4. [–ò—Ç–æ–≥–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞](#–∏—Ç–æ–≥–æ–≤–∞—è-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
5. [–ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ü—Ä–æ–≤–µ—Ä–∫–∏](#—á–µ–∫–ª–∏—Å—Ç-–¥–ª—è-–ø—Ä–æ–≤–µ—Ä–∫–∏)

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –†–µ—à–µ–Ω–∏—è

### ‚úÖ –ß–¢–û –î–ï–õ–ê–ï–ú:

1. **Soft Delete –≤ –ë–î** (`deletedAt` field)
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î
   - Production-ready –ø–∞—Ç—Ç–µ—Ä–Ω (Gmail, Slack, Trello)
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å "Trash" view

2. **useEffectEvent –¥–ª—è event handlers**
   - Experimental API React 19
   - –†–µ—à–∞–µ—Ç stale closures —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ
   - –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø—É—Å—Ç–æ–π deps array)

3. **Server/Client Split**
   - Server Component –¥–ª—è data fetching
   - Client Component –¥–ª—è interactivity
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

4. **3-Layer Hook Composition**
   - Layer 1: Presentation (UI-specific)
   - Layer 2: Operations (business logic)
   - Layer 3: State (pure state management)

5. **–ï–¥–∏–Ω—ã–π Optimistic State**
   - –û–¥–∏–Ω `useOptimistic` –≤ TodoContainer
   - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤–Ω–∏–∑ —á–µ—Ä–µ–∑ props
   - –†–µ—à–∞–µ—Ç race conditions

### ‚ùå –ß–¢–û –ù–ï –î–ï–õ–ê–ï–ú:

1. **PPR (Partial Prerendering)**
   - –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ canary
   - –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π API
   - –û—Ç–ª–æ–∂–∏–º –¥–æ stable —Ä–µ–ª–∏–∑–∞

2. **–û—Ç–¥–µ–ª—å–Ω—ã–π restore action –±–µ–∑ soft delete**
   - Soft delete –ª—É—á—à–µ –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–æ–ª—å—à–µ –Ω–∞–≤—ã–∫–æ–≤

---

## üìö –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –û—Å–Ω–æ–≤—ã

### 1Ô∏è‚É£ Soft Delete Pattern

#### –ü—Ä–æ–±–ª–µ–º–∞ –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ–º:

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** ([useTodoDelete.ts:33-46](../src/hooks/useTodoDelete.ts)):

```typescript
function cancelDeletion(todoId: string) {
  pending.restorable = false;
  updateOptimisticTodos({ type: 'add', todo: pending.todo }); // ‚Üê UI –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  // –ù–û –µ—Å–ª–∏ action –£–ñ–ï —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–∏–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Üí –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ!
}
```

**Timeline –ø—Ä–æ–±–ª–µ–º—ã:**

```
0ms   ‚Üí User –∫–ª–∏–∫–∞–µ—Ç Delete
0ms   ‚Üí UI: todo —É–¥–∞–ª–µ–Ω optimistically
0ms   ‚Üí Server: deleteTodoAction(id) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
500ms ‚Üí Server: todo —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –ë–î ‚úÖ
2000ms ‚Üí User –∫–ª–∏–∫–∞–µ—Ç Undo
2000ms ‚Üí UI: todo –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ
       ‚Üí –ù–û –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –µ–≥–æ –ù–ï–¢! ‚ùå
Refresh ‚Üí todo –∏—Å—á–µ–∑–∞–µ—Ç
```

#### –†–µ—à–µ–Ω–∏–µ: Soft Delete

**–í–º–µ—Å—Ç–æ:**

```sql
DELETE FROM todos WHERE id = ?;
```

**–î–µ–ª–∞–µ–º:**

```sql
UPDATE todos SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

| –ö—Ä–∏—Ç–µ—Ä–∏–π              | Hard Delete    | Soft Delete              |
| --------------------- | -------------- | ------------------------ |
| ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è        | ‚ùå             | ‚úÖ                       |
| createdAt —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | ‚ùå             | ‚úÖ                       |
| Audit trail           | ‚ùå             | ‚úÖ                       |
| "Trash" view          | ‚ùå             | ‚úÖ                       |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ        | –°–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ | UPDATE deleted_at = NULL |
| –î–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ         | ‚≠ê Good        | ‚≠ê‚≠ê‚≠ê Excellent         |

**Production –ø—Ä–∏–º–µ—Ä—ã:**

- Gmail: Trash 30 –¥–Ω–µ–π ‚Üí auto-delete
- Slack: "[deleted]" messages
- Trello: Archive ‚Üí restore
- GitHub: Deleted repos ‚Üí 90 days restore

---

### 2Ô∏è‚É£ useEffectEvent - Event Handlers

#### –ü—Ä–æ–±–ª–µ–º–∞: Stale Closures

**–ë–ï–ó useEffectEvent:**

```typescript
function useTodoDelete({ onDeleteSuccess }) {
  // ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: onDeleteSuccess –º–æ–∂–µ—Ç –±—ã—Ç—å stale
  const handleDelete = useCallback(async (todo) => {
    await action(todo.id);
    onDeleteSuccess?.(todo); // ‚Üê –°—Ç–∞—Ä—ã–π callback –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è!
  }, [action, onDeleteSuccess]); // ‚Üê –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ deps

  return { handleDelete };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
<Button onClick={() => handleDelete(todo)} />
// –ö–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Üí re-render –¥–µ—Ç–µ–π!
```

**–° useEffectEvent:**

```typescript
function useTodoDelete({ onDeleteSuccess }) {
  // ‚úÖ Event handler - –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π, –Ω–æ –Ω–µ reactive
  const onDeleteEvent = useEffectEvent(async (todo) => {
    await action(todo.id);
    onDeleteSuccess?.(todo); // ‚Üê –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π callback!
  });

  const handleDelete = useCallback(async (todo) => {
    await onDeleteEvent(todo);
  }, []); // ‚Üê –ü—É—Å—Ç–æ–π deps! –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è!

  return { handleDelete };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
<Button onClick={() => handleDelete(todo)} />
// –í—Å–µ–≥–¥–∞ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è ‚Üí –Ω–µ—Ç re-render!
```

#### –ö–æ–≥–¥–∞ –ù–£–ñ–ï–ù useEffectEvent?

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: Callback props –º–µ–Ω—è—é—Ç—Å—è**

```typescript
function useTodoDelete({ todos, onDelete }) {
  // ‚úÖ –° useEffectEvent
  const onDeleteEvent = useEffectEvent((todo) => {
    onDelete?.(todo); // –í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π onDelete
  });

  const handleDelete = useCallback(async (todo) => {
    await action(todo.id);
    onDeleteEvent(todo);
  }, []); // –°—Ç–∞–±–∏–ª—å–Ω—ã–π!
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: State –≤ closures**

```typescript
function useTodoDelete() {
  const [currentUser, setCurrentUser] = useState();

  // ‚úÖ –° useEffectEvent
  const onLogEvent = useEffectEvent((todo) => {
    logEvent(currentUser, todo); // –í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π currentUser
  });

  const handleDelete = useCallback(async (todo) => {
    await action(todo.id);
    onLogEvent(todo);
  }, []); // currentUser –ù–ï –≤ deps!
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ callbacks (–≤–∞—à —Å–ª—É—á–∞–π!)**

```typescript
function useTodoDelete() {
  const pendingDeletions = useRef<Map>();

  // ‚úÖ Event handler - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π restorable
  const onExecuteDeletion = useEffectEvent(async (id: string, todo: Todo) => {
    const pending = pendingDeletions.current.get(id);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–¥ delete - –º–æ–∂–µ—Ç —É–∂–µ Undo!
    if (!pending?.restorable) {
      console.log('Deletion cancelled, skipping');
      return; // üéØ –ù–µ —É–¥–∞–ª—è–µ–º
    }

    const result = await action(id);
    if (!result.success && pending?.restorable) {
      // Restore on error
      await restoreOptimistically(todo);
    }
  });

  function handleTodoDelete(todo: Todo) {
    // Optimistic delete
    updateOptimistic({ type: 'delete', id: todo.id });

    // Schedule deletion (5 —Å–µ–∫—É–Ω–¥ –Ω–∞ undo)
    const timerId = setTimeout(() => {
      pendingDeletions.current.delete(todo.id);
    }, 5000);

    pendingDeletions.current.set(todo.id, {
      todo,
      timerId,
      restorable: true,
    });

    // Execute immediately (–ù–ï —á–µ—Ä–µ–∑ setTimeout!)
    onExecuteDeletion(todo.id, todo); // ‚Üê –í—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π restorable
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ useRef?**

| –ê—Å–ø–µ–∫—Ç               | useRef (—Ç–µ–∫—É—â–∏–π)    | useEffectEvent            |
| -------------------- | ------------------- | ------------------------- |
| –†–∞–±–æ—Ç–∞–µ—Ç?            | ‚úÖ –î–∞               | ‚úÖ –î–∞                     |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å           | ‚≠ê‚≠ê –ú—É—Ç–∞—Ü–∏—è ref    | ‚≠ê‚≠ê‚≠ê –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π      |
| –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π | ‚ùå deps array –Ω—É–∂–µ–Ω | ‚úÖ –ü—É—Å—Ç–æ–π deps            |
| Callback props       | ‚ùå –ú–æ–≥—É—Ç stale      | ‚úÖ –í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ          |
| –î–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ        | ‚≠ê‚≠ê                | ‚≠ê‚≠ê‚≠ê (experimental API) |

---

### 3Ô∏è‚É£ Server vs Client Components

#### –ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:

```
"Server by default, Client when needed"
```

#### Decision Tree:

```
–ù—É–∂–Ω—ã React hooks (useState, useOptimistic, useEffect)?
‚îú‚îÄ –î–ê ‚Üí 'use client'
‚îî‚îÄ –ù–ï–¢
    ‚Üì
    Async data fetching?
    ‚îú‚îÄ –î–ê ‚Üí Server Component (async function)
    ‚îî‚îÄ –ù–ï–¢ ‚Üí Server Component (default)
```

#### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è TodoContainer:

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–≤—Å–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ):**

```tsx
'use client';

export default function TodoPage() {
  // Client-side fetch - –ø–ª–æ—Ö–æ –¥–ª—è SEO!
  const { data: todos } = useTodos();

  return (
    <>
      <TodoForm />
      <TodoList todos={todos} />
    </>
  );
}
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (Server ‚Üí Client boundary):**

```tsx
// app/todos/page.tsx (Server Component)
export default async function TodoPage() {
  // Server-side fetch - SEO friendly!
  const todos = await getTodosAction();

  return (
    <main>
      <h1>My Tasks</h1>
      {/* Client boundary starts here ‚¨áÔ∏è */}
      <TodoContainer initialTodos={todos} />
    </main>
  );
}

// components/TodoContainer.tsx (Client Component)
('use client');

export function TodoContainer({ initialTodos }) {
  // ‚úÖ Single source of truth –¥–ª—è optimistic state
  const [optimistic, update] = useOptimistic(initialTodos);

  return (
    <>
      <TodoForm update={update} />
      <TodoList todos={optimistic} />
    </>
  );
}
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **SEO:** HTML —Å todos —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. **Performance:** –ú–µ–Ω—å—à–µ JS –±–∞–Ω–¥–ª –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
3. **Security:** DB credentials –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. **Caching:** Server Components –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è
5. **Initial Load:** –ë—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (SSR)

---

### 4Ô∏è‚É£ Hook Composition - 3 Layers

#### –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

**–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ state:**

```typescript
// useTodoCreate.ts:40
const [optimisticTodos, updateOptimistic] = useOptimisticTodos(todos);

// useTodoDelete.ts:20
const [optimisticTodos, updateOptimistic] = useOptimisticTodos(todos);

// ‚ùå –≠—Ç–æ –î–í–ê –†–ê–ó–ù–´–• —ç–∫–∑–µ–º–ø–ª—è—Ä–∞! –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!
```

**Mixing concerns –≤ useTodoCreate:**

```typescript
export function useTodoCreate({ action, todos, onSuccess }) {
  // ‚ùå 4 —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º —Ö—É–∫–µ:

  // 1. Form state
  const formRef = useRef();
  const inputRef = useRef();

  // 2. Validation
  const parsed = formSchema.safeParse();

  // 3. Optimistic updates
  const [optimistic, update] = useOptimisticTodos(todos);

  // 4. Keyboard shortcuts
  useEffect(() => {
    window.addEventListener('keydown', handleKeyDown);
  }, []);
}
```

#### –†–µ—à–µ–Ω–∏–µ: 3-Layer Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 1: Presentation Hooks                  ‚îÇ
‚îÇ (UI-specific, —Ñ–æ—Ä–º–∞/—Å–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞)        ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ  useTodoForm({ addOptimistically })          ‚îÇ
‚îÇ  - formRef, inputRef                         ‚îÇ
‚îÇ  - validation (Zod)                          ‚îÇ
‚îÇ  - keyboard shortcuts (‚åòK)                   ‚îÇ
‚îÇ  - toast notifications                       ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ  useTodoDelete({ remove, restore })          ‚îÇ
‚îÇ  - undo timer (5 sec)                        ‚îÇ
‚îÇ  - toast with Undo button                    ‚îÇ
‚îÇ  - pendingDeletions map                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ –∏—Å–ø–æ–ª—å–∑—É—é—Ç
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 2: Business Logic Hooks                ‚îÇ
‚îÇ (Reusable operations)                         ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ  useTodoOperations({                         ‚îÇ
‚îÇ    optimisticTodos,                          ‚îÇ
‚îÇ    updateOptimistic,                         ‚îÇ
‚îÇ    actions                                   ‚îÇ
‚îÇ  })                                          ‚îÇ
‚îÇ  - addOptimistically()                       ‚îÇ
‚îÇ  - removeOptimistically()                    ‚îÇ
‚îÇ  - restoreOptimistically()                   ‚îÇ
‚îÇ  - updateOptimistically()                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Layer 3: State Management                    ‚îÇ
‚îÇ (Pure state)                                  ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ  useOptimistic(todos, reducer)               ‚îÇ
‚îÇ  - optimisticState                           ‚îÇ
‚îÇ  - updateOptimistic                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### –ü—Ä–∏–º–µ—Ä: useTodoForm (Layer 1)

```typescript
// –¢–û–õ–¨–ö–û form-specific –ª–æ–≥–∏–∫–∞
export function useTodoForm({ addOptimistically, onSuccess }) {
  const formRef = useRef<HTMLFormElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  // Form state management
  const [state, formAction, isPending] = useActionState(
    async (_: FormState, formData: FormData) => {
      // Validation
      const parsed = formSchema.safeParse(/* ... */);
      if (!parsed.success) return { success: false, issues: [] };

      // Business logic - –¥–µ–ª–µ–≥–∏—Ä—É–µ–º!
      const result = await addOptimistically(parsed.data.description);

      // UI feedback
      if (result.success) {
        toast.success('Task created');
        formRef.current?.reset();
      }

      return result.success ? initialState : { success: false };
    },
    initialState
  );

  // Keyboard shortcut (UI concern)
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        inputRef.current?.focus();
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  return { formRef, inputRef, formAction, isPending, issues: state.issues };
}
```

#### –ü—Ä–∏–º–µ—Ä: useTodoOperations (Layer 2)

```typescript
// Reusable business logic
export function useTodoOperations({
  optimisticTodos,
  updateOptimistic,
  createAction,
  deleteAction,
  restoreAction,
}) {
  // ‚úÖ –° useEffectEvent - —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const onCreate = useEffectEvent(async (description: string) => {
    const tempId = `temp-${Date.now()}`;
    const tempTodo = {
      id: tempId,
      description,
      createdAt: new Date().toISOString(),
      deletedAt: null,
    };

    // Optimistic add
    updateOptimistic({ type: 'add', todo: tempTodo });

    // Server action
    const result = await createAction(description);

    // Remove temp
    updateOptimistic({ type: 'delete', id: tempId });

    return result;
  });

  const onRemove = useEffectEvent(async (todo: Todo) => {
    // Optimistic delete
    updateOptimistic({ type: 'delete', id: todo.id });

    // Server action (soft delete)
    const result = await deleteAction(todo.id);

    // Restore on error
    if (!result.success) {
      updateOptimistic({ type: 'add', todo });
    }

    return result;
  });

  const onRestore = useEffectEvent(async (todo: Todo) => {
    // Optimistic restore
    updateOptimistic({ type: 'add', todo });

    // Server action (undelete)
    const result = await restoreAction(todo.id);

    // Remove on error
    if (!result.success) {
      updateOptimistic({ type: 'delete', id: todo.id });
    }

    return result;
  });

  // ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø—É—Å—Ç–æ–π deps)
  const addOptimistically = useCallback(async (description: string) => onCreate(description), []);

  const removeOptimistically = useCallback(async (todo: Todo) => onRemove(todo), []);

  const restoreOptimistically = useCallback(async (todo: Todo) => onRestore(todo), []);

  return {
    optimisticTodos,
    addOptimistically,
    removeOptimistically,
    restoreOptimistically,
  };
}
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 3-layer:

1. **Single Responsibility:** –ö–∞–∂–¥—ã–π —Ö—É–∫ = –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞
2. **Testability:** –õ–µ–≥–∫–æ –º–æ–∫–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
3. **Reusability:** Operations –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
4. **Maintainability:** –ü–æ–Ω—è—Ç–Ω–æ –≥–¥–µ —á—Ç–æ –ª–µ–∂–∏—Ç
5. **Scalability:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## üèóÔ∏è –ü–æ—à–∞–≥–æ–≤–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î - Soft Delete

#### 1.1 –û–±–Ω–æ–≤–∏—Ç—å schema

**–§–∞–π–ª:** `src/db/drizzle/schema.ts`

```typescript
import { sqliteTable, text } from 'drizzle-orm/sqlite-core';

export const todos = sqliteTable('todos', {
  id: text('id').primaryKey(),
  description: text('description').notNull(),
  createdAt: text('created_at').notNull(),
  deletedAt: text('deleted_at'), // ‚ú® –ù–û–í–û–ï –ø–æ–ª–µ!
});

export type Todo = typeof todos.$inferSelect;
export type NewTodo = typeof todos.$inferInsert;
```

#### 1.2 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
npm run drizzle:generate
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –§–∞–π–ª —Å–æ–∑–¥–∞–Ω –≤ `drizzle/migrations/XXXX_add_deleted_at.sql`

```sql
-- Migration generated by Drizzle
ALTER TABLE `todos` ADD `deleted_at` text;
```

#### 1.3 –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
npm run drizzle:migrate:dev
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ó–∞–ø—É—Å—Ç–∏—Ç—å SQLite –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```bash
sqlite3 dev.db.sqlite3
.schema todos
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ `deleted_at`.

---

### –®–∞–≥ 2: Server Actions

#### 2.1 –û–±–Ω–æ–≤–∏—Ç—å deleteTodoAction (Soft Delete)

**–§–∞–π–ª:** `src/core/todo/actions/delete-todo.action.ts`

**–ë–´–õ–û:**

```typescript
export async function deleteTodoAction(id: string) {
  await db.delete(todos).where(eq(todos.id, id));
  revalidatePath('/');
  return { success: true };
}
```

**–°–¢–ê–õ–û:**

```typescript
'use server';

import { db } from '@/db/drizzle/db';
import { todos } from '@/db/drizzle/schema';
import { eq } from 'drizzle-orm';
import { revalidatePath } from 'next/cache';

export async function deleteTodoAction(id: string) {
  try {
    // ‚ú® Soft delete –≤–º–µ—Å—Ç–æ hard delete
    await db.update(todos).set({ deletedAt: new Date().toISOString() }).where(eq(todos.id, id));

    revalidatePath('/todos');

    return { success: true };
  } catch (error) {
    console.error('Delete todo error:', error);
    return {
      success: false,
      errors: ['Failed to delete task'],
    };
  }
}
```

#### 2.2 –°–æ–∑–¥–∞—Ç—å restoreTodoAction

**–§–∞–π–ª:** `src/core/todo/actions/restore-todo.action.ts` ‚ú® –ù–û–í–´–ô

```typescript
'use server';

import { db } from '@/db/drizzle/db';
import { todos } from '@/db/drizzle/schema';
import { eq } from 'drizzle-orm';
import { revalidatePath } from 'next/cache';

export async function restoreTodoAction(id: string) {
  try {
    // ‚ú® Undelete: set deletedAt = null
    await db.update(todos).set({ deletedAt: null }).where(eq(todos.id, id));

    revalidatePath('/todos');

    return { success: true };
  } catch (error) {
    console.error('Restore todo error:', error);
    return {
      success: false,
      errors: ['Failed to restore task'],
    };
  }
}
```

#### 2.3 –û–±–Ω–æ–≤–∏—Ç—å getTodosAction

**–§–∞–π–ª:** `src/core/todo/actions/get-todos.action.ts`

**–ë–´–õ–û:**

```typescript
export async function getTodosAction() {
  return await db.select().from(todos).orderBy(desc(todos.createdAt));
}
```

**–°–¢–ê–õ–û:**

```typescript
'use server';

import { db } from '@/db/drizzle/db';
import { todos } from '@/db/drizzle/schema';
import { desc, isNull } from 'drizzle-orm';

export async function getTodosAction() {
  // ‚ú® –§–∏–ª—å—Ç—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ (deletedAt IS NULL)
  return await db
    .select()
    .from(todos)
    .where(isNull(todos.deletedAt))
    .orderBy(desc(todos.createdAt));
}
```

#### 2.4 –°–æ–∑–¥–∞—Ç—å type definitions

**–§–∞–π–ª:** `src/core/todo/actions/todo.action.types.ts`

```typescript
export type CreateTodoAction = (description: string) => Promise<{
  success: boolean;
  errors?: string[];
}>;

export type DeleteTodoAction = (id: string) => Promise<{
  success: boolean;
  errors?: string[];
}>;

export type RestoreTodoAction = (id: string) => Promise<{
  success: boolean;
  errors?: string[];
}>;

export type GetTodosAction = () => Promise<Todo[]>;
```

---

### –®–∞–≥ 3: Hook Layer (–ì–ª–∞–≤–Ω–∞—è —á–∞—Å—Ç—å!)

#### 3.1 –û–±–Ω–æ–≤–∏—Ç—å useOptimisticTodos (Layer 3)

**–§–∞–π–ª:** `src/hooks/useOptimisticTodos.ts`

**–ë–´–õ–û:**

```typescript
type OptimisticAction = { type: 'delete'; id: string } | { type: 'add'; todo: Todo };
```

**–°–¢–ê–õ–û:**

```typescript
import { Todo } from '@/core/todo/schemas/todo.contract';
import { useOptimistic } from 'react';

type OptimisticAction =
  | { type: 'delete'; id: string }
  | { type: 'add'; todo: Todo }
  | { type: 'update'; id: string; data: Partial<Todo> }; // ‚ú® –ù–û–í–´–ô!

export function useOptimisticTodos(todos: Todo[]) {
  return useOptimistic(todos, (state, action: OptimisticAction) => {
    switch (action.type) {
      case 'delete':
        return state.filter((todo) => todo.id !== action.id);
      case 'add':
        return [...state, action.todo];
      case 'update':
        return state.map((todo) => (todo.id === action.id ? { ...todo, ...action.data } : todo));
      default:
        return state;
    }
  });
}
```

#### 3.2 –°–æ–∑–¥–∞—Ç—å useTodoOperations (Layer 2) ‚ú® –ù–û–í–´–ô

**–§–∞–π–ª:** `src/hooks/useTodoOperations.ts`

```typescript
import { Todo } from '@/core/todo/schemas/todo.contract';
import {
  CreateTodoAction,
  DeleteTodoAction,
  RestoreTodoAction,
} from '@/core/todo/actions/todo.action.types';
import { useCallback } from 'react';
import { useEffectEvent } from 'react'; // ‚ú® Experimental!

type UseTodoOperationsProps = {
  optimisticTodos: Todo[];
  updateOptimistic: (action: any) => void;
  createAction: CreateTodoAction;
  deleteAction: DeleteTodoAction;
  restoreAction: RestoreTodoAction;
};

export function useTodoOperations({
  optimisticTodos,
  updateOptimistic,
  createAction,
  deleteAction,
  restoreAction,
}: UseTodoOperationsProps) {
  // ‚ú® Event handlers - –≤—Å–µ–≥–¥–∞ –≤–∏–¥—è—Ç —Å–≤–µ–∂–∏–µ props
  const onCreate = useEffectEvent(async (description: string) => {
    const tempId = `temp-${Date.now()}`;
    const tempTodo: Todo = {
      id: tempId,
      description,
      createdAt: new Date().toISOString(),
      deletedAt: null,
    };

    // Optimistic add
    updateOptimistic({ type: 'add', todo: tempTodo });

    try {
      // Server action
      const result = await createAction(description);

      // Remove temp todo
      updateOptimistic({ type: 'delete', id: tempId });

      return result;
    } catch (error) {
      // Cleanup on error
      updateOptimistic({ type: 'delete', id: tempId });
      return {
        success: false,
        errors: [error instanceof Error ? error.message : 'Unknown error'],
      };
    }
  });

  const onRemove = useEffectEvent(async (todo: Todo) => {
    // Optimistic delete
    updateOptimistic({ type: 'delete', id: todo.id });

    try {
      // Server action (soft delete)
      const result = await deleteAction(todo.id);

      if (!result.success) {
        // Restore on error
        updateOptimistic({ type: 'add', todo });
      }

      return result;
    } catch (error) {
      // Restore on error
      updateOptimistic({ type: 'add', todo });
      return {
        success: false,
        errors: [error instanceof Error ? error.message : 'Unknown error'],
      };
    }
  });

  const onRestore = useEffectEvent(async (todo: Todo) => {
    // Optimistic restore
    updateOptimistic({ type: 'add', todo });

    try {
      // Server action (undelete: set deletedAt = null)
      const result = await restoreAction(todo.id);

      if (!result.success) {
        // Remove on error
        updateOptimistic({ type: 'delete', id: todo.id });
      }

      return result;
    } catch (error) {
      // Remove on error
      updateOptimistic({ type: 'delete', id: todo.id });
      return {
        success: false,
        errors: [error instanceof Error ? error.message : 'Unknown error'],
      };
    }
  });

  // ‚úÖ Stable functions (empty deps)
  const addOptimistically = useCallback(
    async (description: string) => onCreate(description),
    [] // ‚Üê onCreate –∏–∑ useEffectEvent –Ω–µ reactive
  );

  const removeOptimistically = useCallback(async (todo: Todo) => onRemove(todo), []);

  const restoreOptimistically = useCallback(async (todo: Todo) => onRestore(todo), []);

  return {
    optimisticTodos,
    addOptimistically,
    removeOptimistically,
    restoreOptimistically,
  };
}
```

**–í–ê–ñ–ù–û:** `useEffectEvent` experimental! –ï—Å–ª–∏ TypeScript —Ä—É–≥–∞–µ—Ç—Å—è:

```typescript
// –í—Ä–µ–º–µ–Ω–Ω—ã–π workaround –¥–æ stable release:
declare module 'react' {
  function useEffectEvent<T extends Function>(fn: T): T;
}
```

#### 3.3 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ useTodoForm (Layer 1)

**–§–∞–π–ª:** `src/hooks/useTodoForm.ts`

**–ë–´–õ–û:** –î–µ–ª–∞–ª –≤—Å–µ —Å–∞–º (validation + optimistic + form + keyboard)

**–°–¢–ê–õ–û:** –¢–æ–ª—å–∫–æ form-specific –ª–æ–≥–∏–∫–∞

```typescript
import { sanitizeStr } from '@/utils/sanitize-str';
import { useActionState, useEffect, useRef } from 'react';
import { toast } from 'sonner';
import z from 'zod';

const formSchema = z.object({
  description: z
    .string()
    .trim()
    .min(1, { message: 'Task must not be empty!' })
    .max(200, { message: 'Task must not be more 200 letters!' })
    .transform(sanitizeStr),
});

type FormState = {
  success: boolean;
  issues?: z.ZodIssue[];
  data: { description: string };
};

const initialState: FormState = {
  success: true,
  issues: undefined,
  data: { description: '' },
};

type UseTodoFormProps = {
  addOptimistically: (description: string) => Promise<{
    success: boolean;
    errors?: string[];
  }>;
  onSuccess?: (description: string) => void;
};

export function useTodoForm({ addOptimistically, onSuccess }: UseTodoFormProps) {
  const formRef = useRef<HTMLFormElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  const [state, formAction, isPending] = useActionState(
    async (_: FormState, formData: FormData): Promise<FormState> => {
      const raw = formData.get('description') as string;

      // Validation
      const parsed = formSchema.safeParse({ description: raw });
      if (!parsed.success) {
        return {
          success: false,
          issues: parsed.error.issues,
          data: { description: raw },
        };
      }

      // ‚úÖ Business logic - –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ useTodoOperations!
      const result = await addOptimistically(parsed.data.description);

      if (!result.success) {
        toast.error('Failed to create task', {
          description: result.errors?.join(', '),
        });

        return {
          success: false,
          issues: result.errors?.map((err) => ({
            code: 'custom' as const,
            path: ['description'],
            message: err,
          })),
          data: { description: raw },
        };
      }

      // Success feedback
      toast.success('Task created', { description: parsed.data.description });
      onSuccess?.(parsed.data.description);
      formRef.current?.reset();

      return initialState;
    },
    initialState
  );

  // Auto-focus on success
  useEffect(() => {
    if (state.success && inputRef.current) {
      inputRef.current.focus();
    }
  }, [state.success]);

  // Keyboard shortcut: ‚åòK
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        inputRef.current?.focus();
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  return {
    formRef,
    inputRef,
    formAction,
    isPending,
    issues: state.issues,
    description: state.data.description,
  };
}
```

#### 3.4 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ useTodoDelete (Layer 1)

**–§–∞–π–ª:** `src/hooks/useTodoDelete.ts`

**–ë–´–õ–û:** –°–æ–∑–¥–∞–≤–∞–ª —Å–≤–æ–π `useOptimisticTodos`, —Å–∞–º –¥–µ–ª–∞–ª delete

**–°–¢–ê–õ–û:** –¢–æ–ª—å–∫–æ delete-specific –ª–æ–≥–∏–∫–∞ (timer + undo)

```typescript
import { Todo } from '@/core/todo/schemas/todo.contract';
import { sanitizeStr } from '@/utils/sanitize-str';
import { useCallback, useEffect, useRef } from 'react';
import { useEffectEvent } from 'react'; // ‚ú® Experimental!
import { toast } from 'sonner';

const CANCEL_TOAST = 500;
const DELETE_DELAY = 5000;

type PendingDeletion = {
  todo: Todo;
  toastId: string | number;
  restorable: boolean;
  timerId: NodeJS.Timeout;
};

type UseTodoDeleteProps = {
  removeOptimistically: (todo: Todo) => Promise<{
    success: boolean;
    errors?: string[];
  }>;
  restoreOptimistically: (todo: Todo) => Promise<{
    success: boolean;
    errors?: string[];
  }>;
};

export function useTodoDelete({ removeOptimistically, restoreOptimistically }: UseTodoDeleteProps) {
  const pendingDeletions = useRef<Map<string, PendingDeletion>>(new Map());

  // ‚ú® Event handler –¥–ª—è restore - –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π callback
  const onRestore = useEffectEvent(async (todo: Todo) => {
    await restoreOptimistically(todo);
  });

  // ‚ú® Event handler –¥–ª—è remove - –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π callback
  const onRemove = useEffectEvent(async (todo: Todo) => {
    await removeOptimistically(todo);
  });

  const cancelDeletion = useCallback(
    async (todoId: string) => {
      console.log('Undo clicked');
      const pending = pendingDeletions.current.get(todoId);
      if (!pending) return;

      // Mark as non-restorable
      pending.restorable = false;
      clearTimeout(pending.timerId);
      pendingDeletions.current.delete(todoId);

      // ‚úÖ Restore —á–µ—Ä–µ–∑ server action (soft delete!)
      await onRestore(pending.todo);

      toast.info('Action cancelled', {
        id: pending.toastId,
        description: 'Task restored successfully',
        duration: CANCEL_TOAST,
      });
    },
    [] // ‚Üê onRestore –∏–∑ useEffectEvent –Ω–µ reactive
  );

  const handleTodoDelete = useCallback(
    async (todo: Todo) => {
      const cleanId = sanitizeStr(todo.id);
      console.log('Delete clicked');

      if (!cleanId) return;
      if (pendingDeletions.current.has(cleanId)) return;

      console.log('Starting deletion...');

      // Show toast with undo
      const toastId = toast.success('Task deleted', {
        description: todo.description,
        duration: DELETE_DELAY,
        action: {
          label: 'Undo',
          onClick: () => cancelDeletion(cleanId),
        },
      });

      // Cleanup timer (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–∞–ø—ã, –ù–ï –¥–ª—è action!)
      const timerId = setTimeout(() => {
        pendingDeletions.current.delete(cleanId);
      }, DELETE_DELAY);

      pendingDeletions.current.set(cleanId, {
        todo,
        toastId,
        restorable: true,
        timerId,
      });

      // ‚úÖ Execute deletion IMMEDIATELY (–Ω–µ —á–µ—Ä–µ–∑ setTimeout!)
      const result = await onRemove(todo);

      if (!result.success) {
        // Error - cleanup
        const pending = pendingDeletions.current.get(cleanId);
        if (pending) {
          clearTimeout(pending.timerId);
          pendingDeletions.current.delete(cleanId);
          toast.error('Failed to delete task', {
            id: toastId,
            description: result.errors?.[0] || 'Unknown error',
          });
        }
      }
    },
    [] // ‚Üê onRemove –∏–∑ useEffectEvent –Ω–µ reactive
  );

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      pendingDeletions.current.forEach((pending) => {
        clearTimeout(pending.timerId);
      });
      pendingDeletions.current.clear();
    };
  }, []);

  return { handleTodoDelete };
}
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

1. ‚úÖ `useEffectEvent` –¥–ª—è `onRestore` –∏ `onRemove`
2. ‚úÖ –ü—É—Å—Ç–æ–π deps array –≤ `useCallback` (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏!)
3. ‚úÖ –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ `useTodoOperations`
4. ‚úÖ –¢–æ–ª—å–∫–æ delete-specific: timer, toast, undo

```
// ‚úÖ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –õ—É—á—à–µ–µ –∏–∑ –æ–±–æ–∏—Ö –º–∏—Ä–æ–≤

// hooks/useTodoDelete.ts
import { Todo } from '@/core/todo/schemas/todo.contract';
import { sanitizeStr } from '@/utils/sanitize-str';
import { useCallback, useEffect, useRef } from 'react';
import { useEffectEvent } from './useEffectEvent';
import { toast } from 'sonner';

const CANCEL_TOAST = 500;
const DELETE_DELAY = 5000;

type PendingDeletion = {
  todo: Todo;
  toastId: string | number;
  restorable: boolean;
  timerId: NodeJS.Timeout;
};

type UseTodoDeleteProps = {
  removeOptimistically: (
    todo: Todo,
    checkRestorable: () => boolean // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
  ) => Promise<{
    success: boolean;
    errors?: string[];
    cancelled?: boolean;
  }>;
  restoreOptimistically: (todo: Todo) => Promise<{
    success: boolean;
    errors?: string[];
  }>;
};

export function useTodoDelete({
  removeOptimistically,
  restoreOptimistically,
}: UseTodoDeleteProps) {
  const pendingDeletions = useRef<Map<string, PendingDeletion>>(new Map());

  const onRestore = useEffectEvent(async (todo: Todo) => {
    await restoreOptimistically(todo);
  });

  const onRemove = useEffectEvent(async (
    todo: Todo,
    checkRestorable: () => boolean
  ) => {
    await removeOptimistically(todo, checkRestorable);
  });

  const cancelDeletion = useCallback(
    async (todoId: string) => {
      console.log('Undo clicked');
      const pending = pendingDeletions.current.get(todoId);
      if (!pending) return;

      // ‚úÖ Mark as non-restorable (onRemove –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å)
      pending.restorable = false;
      clearTimeout(pending.timerId);
      pendingDeletions.current.delete(todoId);

      // Restore
      await onRestore(pending.todo);

      toast.info('Action cancelled', {
        id: pending.toastId,
        description: 'Task restored successfully',
        duration: CANCEL_TOAST,
      });
    },
    []
  );

  const handleTodoDelete = useCallback(
    async (todo: Todo) => {
      const cleanId = sanitizeStr(todo.id);

      if (!cleanId) return;
      if (pendingDeletions.current.has(cleanId)) return;

      console.log('Starting deletion...');

      const toastId = toast.success('Task deleted', {
        description: todo.description,
        duration: DELETE_DELAY,
        action: {
          label: 'Undo',
          onClick: () => cancelDeletion(cleanId),
        },
      });

      // ‚úÖ Timer marks as non-restorable after delay
      const timerId = setTimeout(() => {
        const pending = pendingDeletions.current.get(cleanId);
        if (pending) {
          pending.restorable = false;
        }
      }, DELETE_DELAY);

      pendingDeletions.current.set(cleanId, {
        todo,
        toastId,
        restorable: true,
        timerId,
      });

      try {
        // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏
        const checkRestorable = () => {
          const pending = pendingDeletions.current.get(cleanId);
          return pending?.restorable === true;
        };

        // Execute deletion
        const result = await onRemove(todo, checkRestorable);

        // ‚úÖ –ï—Å–ª–∏ cancelled - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (result.cancelled) {
          console.log('Deletion cancelled by user');
          return;
        }

        // Handle error
        if (!result.success) {
          const pending = pendingDeletions.current.get(cleanId);
          if (pending) {
            toast.error('Failed to delete task', {
              id: toastId,
              description: result.errors?.[0] || 'Unknown error',
            });
          }
        }
      } finally {
        // ‚úÖ Always cleanup after action completes
        const pending = pendingDeletions.current.get(cleanId);
        if (pending) {
          clearTimeout(pending.timerId);
          pendingDeletions.current.delete(cleanId);
        }
      }
    },
    []
  );

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      pendingDeletions.current.forEach((pending) => {
        clearTimeout(pending.timerId);
      });
      pendingDeletions.current.clear();
    };
  }, []);

  return { handleTodoDelete };
}

// hooks/useTodoOperations.ts
export function useTodoOperations({
  optimisticTodos,
  updateOptimistic,
  deleteAction,
  restoreAction,
}) {
  const onRemove = useEffectEvent(async (
    todo: Todo,
    checkRestorable: () => boolean // ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
  ) => {
    // Optimistic delete
    updateOptimistic({ type: 'delete', id: todo.id });

    // ‚úÖ –ü–ï–†–í–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –ü–ï–†–ï–î server action
    if (!checkRestorable()) {
      console.log('‚ùå Not restorable, skipping server action');
      updateOptimistic({ type: 'add', todo });
      return { success: false, cancelled: true };
    }

    try {
      // Server action (soft delete)
      const result = await deleteAction(todo.id);

      // ‚úÖ –í–¢–û–†–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –ü–û–°–õ–ï server action (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥–æ–ª–≥–æ–≥–æ network)
      if (!checkRestorable()) {
        console.log('‚ö†Ô∏è Cancelled after server action, rolling back');
        // Rollback
        await restoreAction(todo.id);
        updateOptimistic({ type: 'add', todo });
        return { success: false, cancelled: true };
      }

      if (!result.success) {
        // Restore on error
        updateOptimistic({ type: 'add', todo });
      }

      return result;
    } catch (error) {
      // Restore on exception
      updateOptimistic({ type: 'add', todo });
      return {
        success: false,
        errors: [error instanceof Error ? error.message : 'Unknown error'],
      };
    }
  });

  const removeOptimistically = useCallback(
    async (todo: Todo, checkRestorable: () => boolean) =>
      onRemove(todo, checkRestorable),
    []
  );

  return {
    optimisticTodos,
    removeOptimistically,
    // ...
  };
}
```

---

### –®–∞–≥ 4: Components

#### 4.1 –°–æ–∑–¥–∞—Ç—å Server Page

**–§–∞–π–ª:** `src/app/todos/page.tsx` ‚ú® –ù–û–í–´–ô

```typescript
import { getTodosAction } from '@/core/todo/actions/get-todos.action';
import { createTodoAction } from '@/core/todo/actions/create-todo.action';
import { deleteTodoAction } from '@/core/todo/actions/delete-todo.action';
import { restoreTodoAction } from '@/core/todo/actions/restore-todo.action';
import { TodoContainer } from '@/components/TodoContainer/TodoContainer';

export default async function TodoPage() {
  // ‚úÖ Server-side data fetch (SEO friendly)
  const todos = await getTodosAction();

  return (
    <main className="container mx-auto p-8">
      <h1 className="text-3xl font-bold mb-8">My Tasks</h1>

      {/* ‚úÖ Client boundary starts here */}
      <TodoContainer
        initialTodos={todos}
        createAction={createTodoAction}
        deleteAction={deleteTodoAction}
        restoreAction={restoreTodoAction}
      />
    </main>
  );
}
```

#### 4.2 –°–æ–∑–¥–∞—Ç—å TodoContainer (Client Coordinator)

**–§–∞–π–ª:** `src/components/TodoContainer/TodoContainer.tsx` ‚ú® –ù–û–í–´–ô

```typescript
'use client';

import { Todo } from '@/core/todo/schemas/todo.contract';
import {
  CreateTodoAction,
  DeleteTodoAction,
  RestoreTodoAction,
} from '@/core/todo/actions/todo.action.types';
import { useOptimisticTodos } from '@/hooks/useOptimisticTodos';
import { useTodoOperations } from '@/hooks/useTodoOperations';
import { useTodoForm } from '@/hooks/useTodoForm';
import { useTodoDelete } from '@/hooks/useTodoDelete';
import { TodoForm } from '../TodoForm';
import { TodoList } from '../TodoList';

type TodoContainerProps = {
  initialTodos: Todo[];
  createAction: CreateTodoAction;
  deleteAction: DeleteTodoAction;
  restoreAction: RestoreTodoAction;
};

export function TodoContainer({
  initialTodos,
  createAction,
  deleteAction,
  restoreAction,
}: TodoContainerProps) {
  // ‚úÖ Layer 3: Single source of truth –¥–ª—è optimistic state
  const [optimisticTodos, updateOptimistic] = useOptimisticTodos(initialTodos);

  // ‚úÖ Layer 2: Business logic operations
  const operations = useTodoOperations({
    optimisticTodos,
    updateOptimistic,
    createAction,
    deleteAction,
    restoreAction,
  });

  // ‚úÖ Layer 1: Presentation hooks
  const formProps = useTodoForm({
    addOptimistically: operations.addOptimistically,
  });

  const deleteProps = useTodoDelete({
    removeOptimistically: operations.removeOptimistically,
    restoreOptimistically: operations.restoreOptimistically,
  });

  return (
    <div className="space-y-8">
      <TodoForm {...formProps} />
      <TodoList
        todos={operations.optimisticTodos}
        onDelete={deleteProps.handleTodoDelete}
      />
    </div>
  );
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ TodoContainer:**

```
TodoContainer (Client)
  ‚îÇ
  ‚îú‚îÄ Layer 3: useOptimisticTodos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                        ‚îÇ
  ‚îú‚îÄ Layer 2: useTodoOperations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ –ü–µ—Ä–µ–¥–∞–µ—Ç –≤–Ω–∏–∑
  ‚îÇ   - addOptimistically                 ‚îÇ
  ‚îÇ   - removeOptimistically              ‚îÇ
  ‚îÇ   - restoreOptimistically             ‚îÇ
  ‚îÇ                                        ‚îÇ
  ‚îú‚îÄ Layer 1: useTodoForm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç addOptimistically      ‚îÇ
  ‚îÇ                                        ‚îÇ
  ‚îú‚îÄ Layer 1: useTodoDelete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç remove/restore         ‚îÇ
  ‚îÇ                                        ‚ñº
  ‚îî‚îÄ Render: TodoForm + TodoList
```

#### 4.3 –£–ø—Ä–æ—Å—Ç–∏—Ç—å TodoForm

**–§–∞–π–ª:** `src/components/TodoForm/index.tsx`

**–ë–´–õ–û:** –ü—Ä–∏–Ω–∏–º–∞–ª `action`, `todos`, —Å–æ–∑–¥–∞–≤–∞–ª —Å–≤–æ–π `useTodoCreate`

**–°–¢–ê–õ–û:** –¢–æ–ª—å–∫–æ UI, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ props

```typescript
'use client';

import { RefObject } from 'react';
import { ZodIssue } from 'zod';
import { TaskInput } from '../TaskInput';

export type TodoFormProps = {
  formRef: RefObject<HTMLFormElement>;
  inputRef: RefObject<HTMLTextAreaElement>;
  formAction: (formData: FormData) => void;
  isPending: boolean;
  description: string;
  issues?: ZodIssue[];
};

export function TodoForm({
  formRef,
  inputRef,
  formAction,
  isPending,
  description,
  issues,
}: TodoFormProps) {
  return (
    <form ref={formRef} action={formAction}>
      <TaskInput
        ref={inputRef}
        label="New Task"
        defaultValue={description}
        disabled={isPending}
        issues={issues}
        placeholder="Add new task... (‚åòK to focus)"
      />
    </form>
  );
}
```

#### 4.4 –£–ø—Ä–æ—Å—Ç–∏—Ç—å TodoList

**–§–∞–π–ª:** `src/components/TodoList/index.tsx`

**–ë–´–õ–û:** –ü—Ä–∏–Ω–∏–º–∞–ª `action`, —Å–æ–∑–¥–∞–≤–∞–ª —Å–≤–æ–π `useTodoDelete`

**–°–¢–ê–õ–û:** –¢–æ–ª—å–∫–æ UI, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π callback

```typescript
import { Todo } from '@/core/todo/schemas/todo.contract';
import { useId } from 'react';
import { Button } from '../ui/Button';
import { Item, ItemActions, ItemContent, ItemGroup, ItemTitle } from '../ui/item';

export type TodoListProps = {
  todos: Todo[];
  onDelete: (todo: Todo) => void;
};

type TodoListItemsProps = {
  todos: Todo[];
  headingId: string;
  onDelete: (todo: Todo) => void;
};

export function TodoList({ todos, onDelete }: TodoListProps) {
  const id = useId();
  const headingId = `heading-${id}`;

  return <TodoListItems todos={todos} headingId={headingId} onDelete={onDelete} />;
}

function TodoListItems({ todos, headingId, onDelete }: TodoListItemsProps) {
  const hasTodos = todos.length > 0;

  if (!hasTodos) {
    return (
      <div role="status" aria-live="polite" className="text-center text-muted-foreground py-12">
        <p>No tasks found</p>
      </div>
    );
  }

  return (
    <ItemGroup
      aria-labelledby={headingId}
      aria-label="Todo list"
      className="flex flex-col min-w-xs max-w-sm gap-4"
    >
      {todos.map((todo) => (
        <Item variant="muted" key={todo.id}>
          <ItemContent>
            <ItemTitle className="line-clamp-2">{todo.description}</ItemTitle>
          </ItemContent>
          <ItemActions>
            <Button
              variant="outline"
              size="sm"
              aria-label={`Delete task: ${todo.description}`}
              onClick={() => onDelete(todo)}
            >
              Close
            </Button>
          </ItemActions>
        </Item>
      ))}
    </ItemGroup>
  );
}
```

---

### –®–∞–≥ 5: Tests

#### 5.1 TodoContainer.test.tsx ‚ú® –ù–û–í–´–ô

**–§–∞–π–ª:** `src/components/TodoContainer/TodoContainer.test.tsx`

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { vi } from 'vitest';
import { TodoContainer } from './TodoContainer';

const mockTodos = [
  {
    id: '1',
    description: 'Test todo',
    createdAt: new Date().toISOString(),
    deletedAt: null,
  },
];

describe('TodoContainer', () => {
  it('renders todos from server', () => {
    const mockActions = {
      createAction: vi.fn(),
      deleteAction: vi.fn(),
      restoreAction: vi.fn(),
    };

    render(<TodoContainer initialTodos={mockTodos} {...mockActions} />);

    expect(screen.getByText('Test todo')).toBeInTheDocument();
  });

  it('creates todo optimistically', async () => {
    const user = userEvent.setup();
    const createAction = vi.fn().mockResolvedValue({ success: true });

    render(
      <TodoContainer
        initialTodos={[]}
        createAction={createAction}
        deleteAction={vi.fn()}
        restoreAction={vi.fn()}
      />
    );

    const input = screen.getByPlaceholderText(/add new task/i);
    await user.type(input, 'New task');
    await user.keyboard('{Enter}');

    // Verify optimistic update
    expect(screen.getByText('New task')).toBeInTheDocument();

    await waitFor(() => {
      expect(createAction).toHaveBeenCalledWith('New task');
    });
  });

  it('handles undo deletion with restore action', async () => {
    const user = userEvent.setup();
    const deleteAction = vi.fn().mockResolvedValue({ success: true });
    const restoreAction = vi.fn().mockResolvedValue({ success: true });

    render(
      <TodoContainer
        initialTodos={mockTodos}
        createAction={vi.fn()}
        deleteAction={deleteAction}
        restoreAction={restoreAction}
      />
    );

    // Delete
    const closeButton = screen.getByRole('button', { name: /delete task/i });
    await user.click(closeButton);

    // Verify optimistic delete
    await waitFor(() => {
      expect(screen.queryByText('Test todo')).not.toBeInTheDocument();
    });

    // Undo
    const undoButton = await screen.findByRole('button', { name: /undo/i });
    await user.click(undoButton);

    // Verify restore action called
    await waitFor(() => {
      expect(restoreAction).toHaveBeenCalledWith('1');
    });
  });
});
```

#### 5.2 useTodoOperations.spec.ts ‚ú® –ù–û–í–´–ô

**–§–∞–π–ª:** `src/hooks/__tests__/useTodoOperations.spec.ts`

```typescript
import { renderHook, waitFor } from '@testing-library/react';
import { vi } from 'vitest';
import { useTodoOperations } from '../useTodoOperations';
import { useOptimisticTodos } from '../useOptimisticTodos';

// Mock useEffectEvent (experimental)
vi.mock('react', async () => {
  const actual = await vi.importActual('react');
  return {
    ...actual,
    useEffectEvent: (fn: any) => fn,
  };
});

describe('useTodoOperations', () => {
  it('adds todo optimistically', async () => {
    const createAction = vi.fn().mockResolvedValue({ success: true });
    const updateOptimistic = vi.fn();

    const { result } = renderHook(() =>
      useTodoOperations({
        optimisticTodos: [],
        updateOptimistic,
        createAction,
        deleteAction: vi.fn(),
        restoreAction: vi.fn(),
      })
    );

    await result.current.addOptimistically('New task');

    // Verify optimistic add called
    expect(updateOptimistic).toHaveBeenCalledWith({
      type: 'add',
      todo: expect.objectContaining({ description: 'New task' }),
    });

    // Verify server action called
    expect(createAction).toHaveBeenCalledWith('New task');

    // Verify temp todo removed
    await waitFor(() => {
      expect(updateOptimistic).toHaveBeenCalledWith({
        type: 'delete',
        id: expect.stringContaining('temp-'),
      });
    });
  });

  it('removes todo and restores on error', async () => {
    const deleteAction = vi.fn().mockResolvedValue({
      success: false,
      errors: ['DB error'],
    });
    const updateOptimistic = vi.fn();

    const todo = {
      id: '1',
      description: 'Test',
      createdAt: new Date().toISOString(),
      deletedAt: null,
    };

    const { result } = renderHook(() =>
      useTodoOperations({
        optimisticTodos: [todo],
        updateOptimistic,
        createAction: vi.fn(),
        deleteAction,
        restoreAction: vi.fn(),
      })
    );

    await result.current.removeOptimistically(todo);

    // Verify optimistic delete
    expect(updateOptimistic).toHaveBeenCalledWith({
      type: 'delete',
      id: '1',
    });

    // Verify restore on error
    await waitFor(() => {
      expect(updateOptimistic).toHaveBeenCalledWith({
        type: 'add',
        todo,
      });
    });
  });
});
```

---

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

#### 6.1 –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md

**–§–∞–π–ª:** `CLAUDE.md`

–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–∫—Ü–∏—é "Common Development Patterns":

````markdown
### Soft Delete Pattern

Todos –∏—Å–ø–æ–ª—å–∑—É—é—Ç soft delete –≤–º–µ—Å—Ç–æ hard delete:

**Schema:**

```typescript
export const todos = sqliteTable('todos', {
  id: text('id').primaryKey(),
  description: text('description').notNull(),
  createdAt: text('created_at').notNull(),
  deletedAt: text('deleted_at'), // null = active, timestamp = deleted
});
```
````

**Querying active todos:**

```typescript
await db.select().from(todos).where(isNull(todos.deletedAt)); // Only active
```

**Delete (soft):**

```typescript
await db.update(todos).set({ deletedAt: new Date().toISOString() }).where(eq(todos.id, id));
```

**Restore:**

```typescript
await db.update(todos).set({ deletedAt: null }).where(eq(todos.id, id));
```

### Hook Composition (3 Layers)

**Layer 3 - State Management:**

- `useOptimisticTodos` - Pure optimistic state

**Layer 2 - Business Logic:**

- `useTodoOperations` - Reusable CRUD operations
- Uses `useEffectEvent` for stable callbacks

**Layer 1 - Presentation:**

- `useTodoForm` - Form-specific logic
- `useTodoDelete` - Delete-specific logic (undo timer)

**Usage:**

```typescript
// TodoContainer coordinates all layers
const [optimistic, update] = useOptimisticTodos(todos);

const operations = useTodoOperations({
  optimisticTodos: optimistic,
  updateOptimistic: update,
  actions,
});

const formProps = useTodoForm({
  addOptimistically: operations.addOptimistically,
});
```

````

#### 6.2 –°–æ–∑–¥–∞—Ç—å ARCHITECTURE.md

**–§–∞–π–ª:** `docs/ARCHITECTURE.md` ‚ú® –ù–û–í–´–ô

```markdown
# Architecture Decision Records

## ADR-001: Soft Delete Pattern

**Context:** Need undo functionality for deleted todos.

**Decision:** Use soft delete with `deletedAt` timestamp.

**Consequences:**
- ‚úÖ Can restore with same ID
- ‚úÖ Audit trail
- ‚úÖ Can add "Trash" view
- ‚ùå Need to filter in all queries

## ADR-002: useEffectEvent for Event Handlers

**Context:** Need stable callbacks that see fresh props.

**Decision:** Use experimental `useEffectEvent` API.

**Consequences:**
- ‚úÖ Stable functions (empty deps)
- ‚úÖ Always fresh closures
- ‚úÖ Shows modern React knowledge
- ‚ùå Experimental (not stable yet)

## ADR-003: 3-Layer Hook Composition

**Context:** Avoid mixing concerns, enable reusability.

**Decision:** Separate hooks into 3 layers:
1. State (useOptimistic)
2. Operations (business logic)
3. Presentation (UI-specific)

**Consequences:**
- ‚úÖ Single Responsibility
- ‚úÖ Testable
- ‚úÖ Reusable
- ‚ùå More files
````

---

## üìÅ –ò—Ç–æ–≥–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –§–∞–π–ª–æ–≤

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                      # –î–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–º–æ–∂–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /todos)
‚îÇ   ‚îî‚îÄ‚îÄ todos/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                  # ‚ú® –ù–û–í–´–ô - Server Component
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ TodoContainer/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TodoContainer.tsx         # ‚ú® –ù–û–í–´–ô - Client –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TodoContainer.test.tsx    # ‚ú® –ù–û–í–´–ô
‚îÇ   ‚îú‚îÄ‚îÄ TodoForm/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.tsx                 # ‚ôªÔ∏è –£–ü–†–û–©–ï–ù (—Ç–æ–ª—å–∫–æ UI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TodoForm.test.tsx         # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TodoForm.stories.tsx      # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ   ‚îî‚îÄ‚îÄ TodoList/
‚îÇ       ‚îú‚îÄ‚îÄ index.tsx                 # ‚ôªÔ∏è –£–ü–†–û–©–ï–ù (—Ç–æ–ª—å–∫–æ UI)
‚îÇ       ‚îú‚îÄ‚îÄ TodoList.test.tsx         # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ       ‚îî‚îÄ‚îÄ TodoList.stories.tsx      # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useOptimisticTodos.ts         # ‚ôªÔ∏è +update action
‚îÇ   ‚îú‚îÄ‚îÄ useTodoOperations.ts          # ‚ú® –ù–û–í–´–ô - Layer 2
‚îÇ   ‚îú‚îÄ‚îÄ useTodoForm.ts                # ‚ôªÔ∏è –†–ï–§–ê–ö–¢–û–†–ò–ù–ì - Layer 1
‚îÇ   ‚îú‚îÄ‚îÄ useTodoDelete.ts              # ‚ôªÔ∏è –†–ï–§–ê–ö–¢–û–†–ò–ù–ì - Layer 1
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îú‚îÄ‚îÄ useTodoOperations.spec.ts # ‚ú® –ù–û–í–´–ô
‚îÇ       ‚îú‚îÄ‚îÄ useTodoForm.spec.ts       # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ       ‚îî‚îÄ‚îÄ useTodoDelete.spec.ts     # ‚ôªÔ∏è –û–ë–ù–û–í–ò–¢–¨
‚îÇ
‚îú‚îÄ‚îÄ core/todo/
‚îÇ   ‚îú‚îÄ‚îÄ actions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-todo.action.ts     # –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ delete-todo.action.ts     # ‚ôªÔ∏è Soft delete
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-todos.action.ts       # ‚ôªÔ∏è Filter deletedAt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restore-todo.action.ts    # ‚ú® –ù–û–í–´–ô
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ todo.action.types.ts      # ‚ôªÔ∏è +RestoreTodoAction
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ todo.contract.ts          # ‚ôªÔ∏è +deletedAt field
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ db/drizzle/
‚îÇ   ‚îî‚îÄ‚îÄ schema.ts                     # ‚ôªÔ∏è +deletedAt field
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ REFACTORING_PLAN.md           # ‚ú® –≠–¢–û–¢ –§–ê–ô–õ
    ‚îú‚îÄ‚îÄ ARCHITECTURE.md               # ‚ú® –ù–û–í–´–ô - ADRs
    ‚îî‚îÄ‚îÄ TESTING_TASKINPUT_LESSON.md   # –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô
```

**–õ–µ–≥–µ–Ω–¥–∞:**

- ‚ú® –ù–û–í–´–ô - —Å–æ–∑–¥–∞—Ç—å —Å –Ω—É–ª—è
- ‚ôªÔ∏è –ò–ó–ú–ï–ù–ò–¢–¨ - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
- –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô - –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –ë–î ‚ú®

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `schema.ts` (+deletedAt)
- [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (`npm run drizzle:generate`)
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (`npm run drizzle:migrate:dev`)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å schema –≤ SQLite

### –®–∞–≥ 2: Server Actions ‚ú®

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `deleteTodoAction` (soft delete)
- [ ] –°–æ–∑–¥–∞—Ç—å `restoreTodoAction`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `getTodosAction` (filter deletedAt)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `todo.action.types.ts`

### –®–∞–≥ 3: Hooks ‚ú®

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `useOptimisticTodos` (+update)
- [ ] –°–æ–∑–¥–∞—Ç—å `useTodoOperations` (Layer 2)
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `useTodoForm` (Layer 1)
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `useTodoDelete` (Layer 1 + useEffectEvent)

### –®–∞–≥ 4: Components ‚ú®

- [ ] –°–æ–∑–¥–∞—Ç—å `app/todos/page.tsx` (Server)
- [ ] –°–æ–∑–¥–∞—Ç—å `TodoContainer` (Client coordinator)
- [ ] –£–ø—Ä–æ—Å—Ç–∏—Ç—å `TodoForm` (—Ç–æ–ª—å–∫–æ UI)
- [ ] –£–ø—Ä–æ—Å—Ç–∏—Ç—å `TodoList` (—Ç–æ–ª—å–∫–æ UI)

### –®–∞–≥ 5: Tests ‚ú®

- [ ] –°–æ–∑–¥–∞—Ç—å `TodoContainer.test.tsx`
- [ ] –°–æ–∑–¥–∞—Ç—å `useTodoOperations.spec.ts`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `useTodoForm.spec.ts`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `useTodoDelete.spec.ts`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `TodoForm.test.tsx`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `TodoList.test.tsx`

### –®–∞–≥ 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚ú®

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `CLAUDE.md`
- [ ] –°–æ–∑–¥–∞—Ç—å `ARCHITECTURE.md`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Storybook stories

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚úÖ

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`npm test`)
- [ ] Build —É—Å–ø–µ—à–µ–Ω (`npm run build`)
- [ ] Storybook —Ä–∞–±–æ—Ç–∞–µ—Ç (`npm run storybook`)
- [ ] –†—É—á–Ω–æ–µ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - [ ] Create todo
  - [ ] Delete todo
  - [ ] Undo delete (restore)
  - [ ] Delete + wait 5 sec (no undo)
  - [ ] Refresh page (soft deleted –Ω–µ –≤–∏–¥–Ω—ã)

---

## üéØ –î–ª—è –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ

–≠—Ç–æ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

1. ‚úÖ **React 19 Advanced** - useOptimistic, useActionState, useEffectEvent
2. ‚úÖ **Next.js 15 Patterns** - Server/Client boundaries, Server Actions
3. ‚úÖ **Clean Architecture** - 3-layer hook composition, SRP
4. ‚úÖ **Database Design** - Soft delete, migrations, audit trails
5. ‚úÖ **UX Excellence** - Optimistic updates, undo, error recovery
6. ‚úÖ **Type Safety** - Full TypeScript, strict types
7. ‚úÖ **Testing** - Unit + integration, high coverage
8. ‚úÖ **Documentation** - ADRs, architecture docs

---

## üìñ –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [React 19 useOptimistic](https://react.dev/reference/react/useOptimistic)
- [React useEffectEvent RFC](https://react.dev/learn/separating-events-from-effects#declaring-an-effect-event)
- [Next.js Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [Drizzle ORM Migrations](https://orm.drizzle.team/docs/migrations)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å? –°–ª–µ–¥—É–π—Ç–µ —á–µ–∫–ª–∏—Å—Ç—É —à–∞–≥ –∑–∞ —à–∞–≥–æ–º!** üöÄ
